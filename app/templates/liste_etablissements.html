{% extends "base.html" %}
{% block scripts_head %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
<script>
let autocomplete;
let map;
let markers = [];

// Fonction pour initialiser l'autocomplétion et la carte
window.initAll = function() {
    initAutocomplete();
    initMap();
};
// Gestion de l'autocomplete
window.initAutocomplete = function() {
    const input = document.getElementById('search');
    const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment'],
        componentRestrictions: {country: 'fr'}
    });

    // Écouter les changements dans l'Autocomplete
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        const allowedTypes = ['bakery', 'cafe', 'bar', 'meal_takeaway', 'restaurant'];

        // Si aucun lieu n'est sélectionné ou pas de géométrie, on sort
        if (!place.geometry) {
            window.alert("Aucun détail disponible pour cette sélection.");
            return;
        }

        // Vérifier si le type du lieu est dans la liste autorisée
        if (place.types) {
            const isAllowed = place.types.some(type => allowedTypes.includes(type));
            if (!isAllowed) {
                window.alert("Seuls les boulangeries, patisseries, cafés et restaurants sont autorisés. Si vous pensez que ce lieu devrait être autorisé, écrivez à contact@planflan.com");
                input.value = ''; // Effacer la sélection
                // Réinitialiser les champs cachés
                document.getElementById('ajout-etab-nom').value = '';
                document.getElementById('ajout-etab-adresse').value = '';
                document.getElementById('ajout-etab-latitude').value = '';
                document.getElementById('ajout-etab-longitude').value = '';
                return; // Arrêter l'exécution si le type n'est pas autorisé
            }
        }

        // Si le type d'établissement est autorisé, remplir les champs cachés
        document.getElementById('ajout-etab-nom').value = place.name || '';
        document.getElementById('ajout-etab-adresse').value = place.formatted_address || '';
        document.getElementById('ajout-etab-latitude').value = place.geometry.location.lat();
        document.getElementById('ajout-etab-longitude').value = place.geometry.location.lng();

    // Vérifier si le lieu est déjà dans la liste
    fetch('/verifier_etablissement', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ nom: place.name }),
    })
    .then(async response => {
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erreur serveur: ${errorText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            console.error("Erreur:", data.error);
            return;
        }
        if (data.exists) {
            const previousMessages = document.querySelectorAll('.alert-warning');
            previousMessages.forEach(msg => msg.remove());
            const message = document.createElement('div');
            message.className = 'alert alert-warning';
            message.innerHTML = `Cet établissement est déjà dans la liste. <a href="${data.url}">Voir la page</a>`;
            document.querySelector('.form-container').prepend(message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'alert alert-danger';
        errorMessage.textContent = `Erreur: ${error.message}`;
        document.querySelector('.form-container').prepend(errorMessage);
    });

        // Envoie l'adresse pour extraire le code postal et la ville
        fetch('/extraire_infos_adresse', {
            method: 'POST',
            headers: {'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content    },
            body: JSON.stringify({ adresse: place.formatted_address }),
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('ajout-etab-code_postal').value = data.code_postal || '';
            document.getElementById('ajout-etab-ville').value = data.ville || '';
            document.getElementById('ajout-etab-adresse').value = data.adresse_nettoyee || '';
        })
        .catch(error => console.error('Erreur:', error));
    });
};

// Gestion de la carte
window.initMap = function() {
    const mapElement = document.getElementById("map");
    if (!mapElement) {
        console.error("Élément #map introuvable !");
        const mapContainer = document.getElementById("map-container");
        if (mapContainer) {
            mapContainer.innerHTML = "<p style='color: red;'>Erreur : Impossible de charger la carte.</p>";
        } else {
            console.error("Élément #map-container introuvable !");
        }
        return;
    }

    map = new google.maps.Map(mapElement, {
        center: { lat: 46.2276, lng: 2.2137 },
        zoom: 6,
    });

    const etablissements = {{ etablissements_json|tojson|safe }};
    const infowindow = new google.maps.InfoWindow();
    const isAdmin = {{ current_user.is_admin|tojson|safe if current_user.is_authenticated else 'false' }};
    const bounds = new google.maps.LatLngBounds();

    etablissements.forEach(etablissement => {
        let icon;
        if (isAdmin) {
if (etablissement.label) {
    icon = "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"; // Labellisé
} else if (etablissement.visite) {
    icon = "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"; // Visité
} else {
    icon = "https://maps.google.com/mapfiles/ms/icons/red-dot.png"; // Ni l'un ni l'autre
}
        } else {
            if (etablissement.label) {
                icon = "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"; // Labellisé
            } else {
                icon = "https://maps.google.com/mapfiles/ms/icons/red-dot.png"; // Non labellisé
            }
        }
        // Création d'un marqueur
        const marker = new google.maps.Marker({
            position: { lat: etablissement.latitude, lng: etablissement.longitude },
            map: map,
            title: etablissement.nom,
            icon: icon
        });

        bounds.extend(marker.position);
        // Adresse de la page de l'établissement
        const detailsUrl = `/etablissement/${etablissement.id_etab}?nom=${nom}&visite=${visite}&labellise=${labellise}`;
        // Contenu de la carte
        const content = `
            <div class="infowindow">
                <h3>${etablissement.nom}</h3>
                <p class="type">${etablissement.type_etab}</p>
                <p class="adresse">${etablissement.adresse}, ${etablissement.ville}</p>
                ${etablissement.flans_count ? `<p class="flans-count">${etablissement.flans_count} flan${etablissement.flans_count > 1 ? 's' : ''}</p>` : ''}
                <a href="${detailsUrl}" class="btn btn-primary">Voir plus</a>
            </div>
        `;

        marker.addListener("click", () => {
            setTimeout(() => {
                infowindow.setContent(content);
                infowindow.open(map, marker);
            }, 50);
        });
        markers.push(marker);
    });
    // Adaptation du zoom selon le nombre d'établissements affichés
    if (etablissements.length > 0) {
        if (etablissements.length === 1) {
            map.setCenter(markers[0].position);
            map.setZoom(18); // Quelques rues autour de l'établissement unique
        } else {
            map.fitBounds(bounds); // S'adaote au nombre d'établissements
        }
    }
    // Légende
    const legend = document.createElement('div');
    legend.style.backgroundColor = 'white';
    legend.style.padding = '10px';
    legend.style.margin = '10px';
    legend.style.border = '1px solid #ccc';

    if (isAdmin) {
        legend.innerHTML = `
            <h3>Legende</h3>
            <p><img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png" alt="Labellisé"> Labellise</p>
            <p><img src="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png" alt="Visité"> Visité</p>
            <p><img src="https://maps.google.com/mapfiles/ms/icons/red-dot.png" alt="Non visité"> Non visité</p>
        `;
    } else {
        legend.innerHTML = `
            <h3><img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png" alt="Labellisé">Labellise </h3>
        `;
    }
    // Légende en bas à gauche
    map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);
};


// Chargement de l'API Google Maps
document.addEventListener('DOMContentLoaded', function() {
    const mapElement = document.getElementById("map");
    if (mapElement) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initAll&v=weekly&loading=async`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    } else {
        console.error("Élément #map introuvable même après le chargement du DOM !");
    }
});
const nom = "{{ request.args.get('nom') }}";
const visite = "{{ request.args.get('visite') }}";
const labellise = "{{ request.args.get('labellise') }}";
</script>


{% endblock %}
{% block content %}
<div class="container">
    <div id="map-container" class="map-container">
        <div id="map"></div>
    </div>
</div>
<!-- Grille des établissements -->
{{ afficher_grille('etablissement', etablissements, current_user, form_edit, form_ajout) }}
{% endblock %}
