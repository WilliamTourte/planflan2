{% extends "base.html" %}
{% block scripts_head %}
    <script>
    const nom = "{{ request.args.get('nom') }}";
    const visite = "{{ request.args.get('visite') }}";
    const labellise = "{{ request.args.get('labellise') }}";
</script>
<script>
    let map;
    let markers = [];

    // Définissez la fonction initMap au niveau global
   window.initMap = function() {
    console.log("Initialisation de la carte...");
    const mapElement = document.getElementById("map");
    if (!mapElement) {
        console.error("Élément #map introuvable !");
        const mapContainer = document.getElementById("map-container");
        if (mapContainer) {
            mapContainer.innerHTML = "<p style='color: red;'>Erreur : Impossible de charger la carte.</p>";
        } else {
            console.error("Élément #map-container introuvable !");
        }
        return;
    }
    map = new google.maps.Map(mapElement, {
        center: { lat: 46.2276, lng: 2.2137 }, // Coordonnées approximatives du centre de la France
        zoom: 6, // Niveau de zoom pour afficher toute la France
    });
    console.log("Carte initialisée avec succès !");
    const etablissements = {{ etablissements_json|tojson|safe }};
    const infowindow = new google.maps.InfoWindow(); // Déplacez cette ligne ici
   etablissements.forEach(etablissement => {
    // L'icône change selon que le lieu a été visité et/ou labellisé
    let icon;
    if (etablissement.visite && etablissement.label) {
        icon = "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
    } else if (etablissement.visite) {
        icon = "http://maps.google.com/mapfiles/ms/icons/red-dot.png";
    } else {
        icon = "http://maps.google.com/mapfiles/ms/icons/blue-dot.png";
    }
    const marker = new google.maps.Marker({
        position: { lat: etablissement.latitude, lng: etablissement.longitude },
        map: map,
        title: etablissement.nom,
        icon: icon
    });
    const detailsUrl = `/etablissement/${etablissement.id_etab}?nom=${nom}&visite=${visite}&labellise=${labellise}`;
    const content = `
        <div class="infowindow">
            <h3>${etablissement.nom}</h3>
            <p class="type">${etablissement.type_etab}</p>
            <p class="adresse">${etablissement.adresse}, ${etablissement.ville}</p>
            ${etablissement.flans_count ? `<p class="flans-count">${etablissement.flans_count} flan${etablissement.flan_count > 1 ? 's' : ''}</p>` : ''}
            <a href="${detailsUrl}">Voir la page</a>
        </div>
    `;
    marker.addListener("click", () => {
        setTimeout(() => {
            infowindow.setContent(content);
            infowindow.open(map, marker);
            const card = document.querySelector(`.carte[data-id="${etablissement.id_etab}"]`);
        }, 50);
    });
    markers.push(marker);
});

    // Créer un élément div pour la légende
    const legend = document.createElement('div');
    legend.style.backgroundColor = 'white';
    legend.style.padding = '10px';
    legend.style.margin = '10px';
    legend.style.border = '1px solid #ccc';
    // Ajouter le contenu de la légende
    legend.innerHTML = `
        <h3>Légende</h3>
        <p><img src="http://maps.google.com/mapfiles/ms/icons/blue-dot.png" alt="Non visité">Non visité</p>
        <p><img src="http://maps.google.com/mapfiles/ms/icons/red-dot.png" alt="Visité"> Visité</p>
        <p><img src="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png" alt="Labellisé">Labellisé</p>
    `;
    // Ajouter la légende à la carte
    map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);
};


    // Ajouter un écouteur d'événement pour DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM complètement chargé et analysé");
        const mapElement = document.getElementById("map");
        if (mapElement) {
            console.log("Élément #map trouvé, chargement du script Google Maps...");
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&v=weekly`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        } else {
            console.error("Élément #map introuvable même après le chargement du DOM !");
        }
    });
</script>
<style>
    #map { height: 80vh; width: 100%; background-color: #f5f5f5; }
    .infowindow { font-family: Arial, sans-serif; }
    .infowindow h3 { margin: 0 0 5px 0; color: #333; }
    .infowindow a { color: #1a73e8; text-decoration: none; }
    .map-container { margin-bottom: 2rem; width: 100%; padding: 0; }
    @media (max-width: 768px) { #map { height: 60vh; } }
</style>
{% endblock %}
{% block content %}
<div class="container">
    <div id="map-container" class="map-container">
        <div id="map"></div>
    </div>
    <!-- Grille des établissements -->
{% from "macros.html" import afficher_grille_etablissements %}
{{ afficher_grille_etablissements(etablissements) }}

{% endblock %}
