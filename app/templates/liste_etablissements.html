{% extends "base.html" %}
{% block scripts_head %}
<script>
let autocomplete;
let map;
let markers = [];

// Fonction pour initialiser l'autocomplétion et la carte
window.initAll = function() {
    initAutocomplete();
    initMap();
};

window.initAutocomplete = function() {
    console.log("Initialisation de l'autocomplétion...");
    const input = document.getElementById('search');
    if (!input) {
        console.error("Élément #search introuvable !");
        return;
    }
    autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment'],  // Limite les résultats aux établissements commerciaux
        componentRestrictions: {country: 'fr'}  // Limite les résultats à la France
    });
    // Écouter les changements dans l'Autocomplete
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        console.log("Lieu sélectionné :", place);  // Log pour déboguer
        if (!place.geometry) return;
        // Remplir les champs avec les données extraites
        document.getElementById('nom').value = place.name || '';
        document.getElementById('adresse').value = place.formatted_address || '';
        document.getElementById('latitude').value = place.geometry.location.lat();
        document.getElementById('longitude').value = place.geometry.location.lng();
        // Vérifier si le lieu est déjà dans la liste
        fetch('/verifier_etablissement', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nom: place.name }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Réponse de la vérification :", data);  // Log pour déboguer
            if (data.exists) {
                // Supprimer les messages précédents
                const previousMessages = document.querySelectorAll('.alert-warning');
                previousMessages.forEach(msg => msg.remove());
                // Créer et afficher le message
                const message = document.createElement('div');
                message.className = 'alert alert-warning';
                message.innerHTML = `Cet établissement est déjà dans la liste. <a href="${data.url}">Voir la page de l'établissement</a>`;
                document.querySelector('.form-container').prepend(message);
            }
        })
        .catch((error) => {
            console.error('Erreur:', error);
        });
        // Envoyer l'adresse à une route AJAX pour extraire le code postal et la ville
        fetch('/extraire_infos_adresse', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ adresse: place.formatted_address }),
        })
        .then(response => response.json())
        .then(data => {
            console.log("Réponse de l'extraction d'adresse :", data);  // Log pour déboguer
            document.getElementById('code_postal').value = data.code_postal || '';
            document.getElementById('ville').value = data.ville || '';
            document.getElementById('adresse').value = data.adresse_nettoyee || '';
        })
        .catch((error) => {
            console.error('Erreur:', error);
        });
    });
};

window.initMap = function() {
    console.log("Initialisation de la carte...");
    const mapElement = document.getElementById("map");
    if (!mapElement) {
        console.error("Élément #map introuvable !");
        const mapContainer = document.getElementById("map-container");
        if (mapContainer) {
            mapContainer.innerHTML = "<p style='color: red;'>Erreur : Impossible de charger la carte.</p>";
        } else {
            console.error("Élément #map-container introuvable !");
        }
        return;
    }
    map = new google.maps.Map(mapElement, {
        center: { lat: 46.2276, lng: 2.2137 }, // Coordonnées approximatives du centre de la France
        zoom: 6, // Niveau de zoom pour afficher toute la France
    });
    console.log("Carte initialisée avec succès !");
    const etablissements = {{ etablissements_json|tojson|safe }};
    const infowindow = new google.maps.InfoWindow(); // Déplacez cette ligne ici

    etablissements.forEach(etablissement => {
        // L'icône change selon que le lieu a été visité et/ou labellisé
        let icon;
        if (etablissement.visite && etablissement.label) {
            icon = "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
        } else if (etablissement.visite) {
            icon = "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
        } else {
            icon = "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";
        }
        const marker = new google.maps.Marker({
            position: { lat: etablissement.latitude, lng: etablissement.longitude },
            map: map,
            title: etablissement.nom,
            icon: icon
        });
        const detailsUrl = `/etablissement/${etablissement.id_etab}?nom=${nom}&visite=${visite}&labellise=${labellise}`;
        const content = `
            <div class="infowindow">
                <h3>${etablissement.nom}</h3>
                <p class="type">${etablissement.type_etab}</p>
                <p class="adresse">${etablissement.adresse}, ${etablissement.ville}</p>
                ${etablissement.flans_count ? `<p class="flans-count">${etablissement.flans_count} flan${etablissement.flans_count > 1 ? 's' : ''}</p>` : ''}
                <a href="${detailsUrl}">Voir la page</a>
            </div>
        `;
        marker.addListener("click", () => {
            setTimeout(() => {
                infowindow.setContent(content);
                infowindow.open(map, marker);
            }, 50);
        });
        markers.push(marker);
    });

    // Créer un élément div pour la légende
    const legend = document.createElement('div');
    legend.style.backgroundColor = 'white';
    legend.style.padding = '10px';
    legend.style.margin = '10px';
    legend.style.border = '1px solid #ccc';
    // Ajouter le contenu de la légende
    legend.innerHTML = `
        <h3>Légende</h3>
        <p><img src="https://maps.google.com/mapfiles/ms/icons/blue-dot.png" alt="Non visité">Non visité</p>
        <p><img src="https://maps.google.com/mapfiles/ms/icons/red-dot.png" alt="Visité"> Visité</p>
        <p><img src="https://maps.google.com/mapfiles/ms/icons/yellow-dot.png" alt="Labellisé">Labellisé</p>
    `;
    // Ajouter la légende à la carte
    map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(legend);
};

// Ajouter un écouteur d'événement pour DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM complètement chargé et analysé");
    const mapElement = document.getElementById("map");
    if (mapElement) {
        console.log("Élément #map trouvé, chargement du script Google Maps...");
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initAll&v=weekly`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    } else {
        console.error("Élément #map introuvable même après le chargement du DOM !");
    }
});

const nom = "{{ request.args.get('nom') }}";
const visite = "{{ request.args.get('visite') }}";
const labellise = "{{ request.args.get('labellise') }}";
</script>
<style>
    .form-container { padding: 10px; }
    .form-group { margin-bottom: 10px; }
    .form-label { display: block; margin-bottom: 5px; }
    .form-control { width: 100%; padding: 5px; }
    .error-message { color: red; }
    .btn-proposer { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; cursor: pointer; }
    .btn-proposer:hover { background-color: #45a049; }
    #map { height: 80vh; width: 100%; background-color: #f5f5f5; }
    .infowindow h3 { margin: 0 0 5px 0; color: #333; }
    .infowindow a { color: #1a73e8; text-decoration: none; }
    .map-container { margin-bottom: 2rem; width: 100%; padding: 0; }
    @media (max-width: 768px) { #map { height: 60vh; } }
</style>
{% endblock %}
{% block content %}
<div class="container">
    <div id="map-container" class="map-container">
        <div id="map"></div>
    </div>
</div>
<!-- Grille des établissements -->
{{ afficher_grille('etablissement', etablissements, current_user, form2, etablissement) }}
{% endblock %}
