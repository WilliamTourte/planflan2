{% extends "base.html" %}
{% block scripts_head %}
<script>
    let map;
    let markers = [];
    window.initMap = function() {  // Pas de paramètre ici
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 48.8566, lng: 2.3522 },
            zoom: 12,
        });
        const etablissements = {{ etablissements_json|tojson|safe }};
        etablissements.forEach(etablissement => {
            const marker = new google.maps.Marker({
                position: { lat: etablissement.latitude, lng: etablissement.longitude },
                map: map,
                title: etablissement.nom,
            });
            // Infobulle avec lien cliquable
            const infowindow = new google.maps.InfoWindow({
                content: `
                    <div class="infowindow">
                        <h3>${etablissement.nom}</h3>
                        <p>${etablissement.adresse}, ${etablissement.code_postal} ${etablissement.ville}</p>
                        <a href="${etablissement.url}" target="_blank" tabindex="-1">Voir la fiche</a>
                    </div>
                `,
            });
            // Ouvre l'infobulle au clic
            marker.addListener("click", (event) => {
                event.preventDefault();
                infowindow.open(map, marker);
            });
        });
    };
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>
<style>
    #map { height: 500px; width: 100%; margin-bottom: 2rem; }
    .infowindow { font-family: Arial, sans-serif; }
    .infowindow h3 { margin: 0 0 5px 0; color: #333; }
    .infowindow a { color: #1a73e8; text-decoration: none; }
    .infowindow a:hover { text-decoration: underline; }
</style>
{% endblock %}
{% block content %}
<h1>Carte des établissements</h1>
<div id="map" style="height: 600px; width: 100%;"></div>
{% endblock %}
{% block scripts %}
<!-- Ce bloc peut rester vide ou contenir d'autres scripts -->
{% endblock %}
