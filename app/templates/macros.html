<!-- MACROS D'AFFICHAGE -->
{% macro afficher_image_ou_placeholder(item, classe='card-image') %}
    {% if item.photos %}
        <img src="{{ url_for('static', filename='uploads/' + item.photos[0].path) }}" alt="{{ item.nom }}" class="{{ classe }}">
    {% else %}
        <div class="{{ classe }} placeholder"><span>Pas de photo</span></div>
    {% endif %}
{% endmacro %}

<!-- BADGES - à refactoriser ? -->
{% macro afficher_badge_etablissement(etablissement) %}
    {% if etablissement.label %}
        <span class="badge">⭐ Labellisé</span>
    {% endif %}
{% endmacro %}

{% macro afficher_badge_flan(flan) %}
    {% if flan.prix is not none %}
        <span class="badge">{{ "%.2f"|format(flan.prix) }} €</span>
    {% else %}
        <span class="badge">Prix non renseigné</span>
    {% endif %}
{% endmacro %}

{% macro afficher_badge_statut(evaluation) %}
    {% if evaluation.statut == 'valide' %}
        <span class="badge statut-valide">Valide</span>
    {% else %}
        <span class="badge statut-en-attente">En attente</span>
    {% endif %}
{% endmacro %}

{% macro afficher_etablissement(etablissement) %}
    <a href="{{ url_for('main.afficher_etablissement_unique', id_etab=etablissement.id_etab) }}" class="carte" data-id="{{ etablissement.id_etab }}" data-lat="{{ etablissement.latitude }}" data-lng="{{ etablissement.longitude }}">
        <div class="card-image-container">
            {{ afficher_image_ou_placeholder(etablissement) }}
            {{ afficher_badge_etablissement(etablissement) }}
        </div>
        <div class="card-content">
            <div class="card-header">
                <h2>{{ etablissement.nom | enlever_accents }}</h2>
            </div>
            <p class="type">{{ etablissement.type_etab.value }}</p>
            <p class="adresse">{{ etablissement.adresse }}, {{ etablissement.ville }}</p>
            {% if etablissement.flans %}
                <p class="flans-count">{{ etablissement.flans|length }} flan{{ 's' if etablissement.flans|length > 1 else '' }}</p>
            {% endif %}
        </div>
    </a>
{% endmacro %}

{% macro afficher_flan(flan) %}
    <div class="card-content">
        <div class="card-header">
            <h3>{{ flan.nom | enlever_accents }}</h3>
            {{ afficher_badge_flan(flan) }}
        </div>
        <p class="type">Saveur : {{ flan.type_saveur.value | default("inconnue") }}</p>
        <p class="type">Pâte : {{ flan.type_pate.value | default("inconnue") }}</p>
        <p class="type">Texture : {{ flan.type_texture.value | default("inconnue") }}</p>
        <p class="type">Description : {{ flan.description | default("Flantastique") }}</p>
        <p class="flan-price">Prix : {{ "%.2f"|format(flan.prix) }} €</p>
    </div>
{% endmacro %}

{% macro afficher_evaluation(evaluation, current_user) %}
    <a href="{{ url_for('main.afficher_flan_unique', id_flan=evaluation.flan.id_flan) }}" class="carte">
        <div class="card-content">
            <div class="card-header">
                <h2>{{ evaluation.flan.etablissement.nom | enlever_accents }}</h2>
                <h3>{{ evaluation.flan.nom | enlever_accents }}</h3>
                {% if evaluation.statut.value == 'VALIDE' %}
                    <span class="badge statut-valide">Valide</span>
                {% else %}
                    <span class="badge statut-en-attente">En attente</span>
                {% endif %}
            </div>
            <div class="evaluation-date-container">
                <small class="evaluation-date">
                    {{ evaluation.date_creation.strftime('%d/%m/%Y') }}
                </small>
            </div>
            <div class="criteria">
                <div class="criterion">
                    <span class="criterion-name">Goût :</span>
                    <span class="criterion-value">{{ evaluation.gout }}/5</span>
                </div>
                <div class="criterion">
                    <span class="criterion-name">Texture :</span>
                    <span class="criterion-value">{{ evaluation.texture }}/5</span>
                </div>
                <div class="criterion">
                    <span class="criterion-name">Visuel :</span>
                    <span class="criterion-value">{{ evaluation.visuel }}/5</span>
                </div>
                <div class="criterion">
                    <span class="criterion-name">Pâte :</span>
                    <span class="criterion-value">{{ evaluation.pate }}/5</span>
                </div>
            </div>
            {% if evaluation.gout is not none and evaluation.texture is not none and evaluation.visuel is not none and evaluation.pate is not none %}
                {% set moyenne = (evaluation.gout + evaluation.texture + evaluation.visuel + evaluation.pate) / 4 %}
                <div class="moyenne">
                    <span class="moyenne-value">{{ moyenne }}/5</span>
                </div>
            {% else %}
                <div class="moyenne">
                    <span class="moyenne-value">N/A</span>
                </div>
            {% endif %}
            <p class="type">{{ evaluation.description }}</p>
            {{ afficher_boutons_actions(evaluation, current_user) }}
        </div>
    </a>
{% endmacro %}

{% macro afficher_grille(objet_type, objets, current_user=None, form=None, etablissement=None, flan=None) %}
    {% if not objets %}
        <div class="no-results">
            <p>Aucun {{ objet_type }} trouvé.</p>
        </div>
    {% else %}
        <div class="grille">
            {% for objet in objets %}
                {{ afficher_objet(objet_type, objet, current_user) }}
            {% endfor %}
        </div>
    {% endif %}
    <!-- BOUTON AJOUT en fin de grille-->
    {% if current_user.is_authenticated %}
        <div class="card-content">
            {{ afficher_bouton_ajout(objet_type, current_user, etablissement, form, flan) }}
        </div>
        {%  else %}
            <div class="card-content">
        <a href="{{ url_for('auth.login', next=request.full_path) }}" class="btn-proposer">
            Ajouter un {{ objet_type }} (connectez-vous)
        </a>
    {% endif %}
{% endmacro %}


{% macro afficher_objet(objet_type, objet, current_user=None) %}
    {% if objet_type == 'etablissement' %}
        {{ afficher_etablissement(objet) }}
    {% elif objet_type == 'flan' %}
        <a href="{{ url_for('main.afficher_flan_unique', id_flan=objet.id_flan) }}" class="carte">
            {{ afficher_image_ou_placeholder(objet) }}
            {{ afficher_flan(objet) }}
        </a>
    {% elif objet_type == 'evaluation' %}
        {{ afficher_evaluation(objet, current_user) }}
    {% endif %}
{% endmacro %}

{% macro afficher_bouton_ajout(objet_type, current_user, etablissement=None, form=None, flan=None) %}
    {% if objet_type == 'etablissement' and current_user.is_authenticated %}
        <div class="card-content">
            <h3>Ajouter un établissement</h3>
            {% if current_user.is_authenticated %}
                {{ ajouter_etablissement(form, url_for('maps.ajouter_etablissement')) }}
            {% else %}
                <a href="{{ url_for('auth.login', next=request.full_path) }}" class="btn-proposer">
                    Ajouter un établissement (connectez-vous)
                </a>
            {% endif %}
        </div>
    {% elif objet_type == 'flan' and etablissement %}
        <div class="card-content">
            <h3>Ajouter un flan</h3>
            {% if current_user.is_authenticated %}
                {{ proposer_flan(form, url_for('main.proposer_flan', id_etab=etablissement.id_etab)) }}
            {% else %}
                <a href="{{ url_for('auth.login', next=request.full_path) }}" class="btn-proposer">
                    Ajouter un flan (connectez-vous)
                </a>
            {% endif %}
        </div>
    {% elif objet_type == 'evaluation' and flan %}
        <div class="card-content">
            <h3>Ajouter une évaluation</h3>
            {% if current_user.is_authenticated %}
                {{ proposer_evaluation(form, url_for('main.evaluer_flan', id_flan=flan.id_flan)) }}
            {% else %}
                <a href="{{ url_for('auth.login', next=request.full_path) }}" class="btn-proposer">
                    Ajouter une évaluation (connectez-vous)
                </a>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}


<!-- MACROS POUR PROPOSER DES CHOSES -->
{% macro proposer_flan(form, action_url) %}
    <!-- Formulaire d'ajout de flan -->
    <form method="POST" action="{{ action_url }}" class="form-container">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.nom.label(class="form-label") }}
            {{ form.nom(class="form-control") }}
            {% if form.nom.errors %}
                <div class="error-message">{{ form.nom.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.type_saveur.label(class="form-label") }}
            {{ form.type_saveur(class="form-control") }}
            {% if form.type_saveur.errors %}
                <div class="error-message">{{ form.type_saveur.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.type_texture.label(class="form-label") }}
            {{ form.type_texture(class="form-control") }}
            {% if form.type_texture.errors %}
                <div class="error-message">{{ form.type_texture.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.type_pate.label(class="form-label") }}
            {{ form.type_pate(class="form-control") }}
            {% if form.type_pate.errors %}
                <div class="error-message">{{ form.type_pate.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control") }}
            {% if form.description.errors %}
                <div class="error-message">{{ form.description.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.prix.label(class="form-label") }}
            {{ form.prix(class="form-control") }}
            {% if form.prix.errors %}
                <div class="error-message">{{ form.prix.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.submit(class="btn btn-proposer") }}
        </div>
    </form>
{% endmacro %}

{% macro ajouter_etablissement(form, action_url) %}
    <!-- Formulaire d'ajout d'établissement -->
    <form method="POST" action="{{ action_url }}" class="form-container">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.type_etab.label(class="form-label") }}
            {{ form.type_etab(class="form-control") }}
            {% if form.type_etab.errors %}
                <div class="error-message">{{ form.type_etab.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            <label for="search" class="form-label">Recherche d'établissement</label>
            <input type="text" id="search" class="form-control" placeholder="Rechercher un établissement">
        </div>
        <div class="form-group">
            {{ form.nom.label(class="form-label") }}
            {{ form.nom(class="form-control", id="nom", readonly=true) }}
            {% if form.nom.errors %}
                <div class="error-message">{{ form.nom.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.adresse.label(class="form-label") }}
            {{ form.adresse(class="form-control", id="adresse", readonly=true) }}
            {% if form.adresse.errors %}
                <div class="error-message">{{ form.adresse.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.code_postal.label(class="form-label") }}
            {{ form.code_postal(class="form-control", id="code_postal", readonly=true) }}
            {% if form.code_postal.errors %}
                <div class="error-message">{{ form.code_postal.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.ville.label(class="form-label") }}
            {{ form.ville(class="form-control", id="ville", readonly=true) }}
            {% if form.ville.errors %}
                <div class="error-message">{{ form.ville.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", id="description") }}
            {% if form.description.errors %}
                <div class="error-message">{{ form.description.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.label.label(class="form-label") }}
            {{ form.label(class="form-control", id="label") }}
            {% if form.label.errors %}
                <div class="error-message">{{ form.label.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.visite.label(class="form-label") }}
            {{ form.visite(class="form-control", id="visite") }}
            {% if form.visite.errors %}
                <div class="error-message">{{ form.visite.errors[0] }}</div>
            {% endif %}
        </div>
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">
        <div class="form-group">
            {{ form.submit(class="btn btn-proposer") }}
        </div>
    </form>
{% endmacro %}


{% macro proposer_evaluation(form, action_url) %}
    <!-- Formulaire d'ajout d'évaluation -->
    <form method="POST" action="{{ action_url }}" class="form-container">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.visuel.label(class="form-label") }}
            {{ form.visuel(class="form-control") }}
            {% if form.visuel.errors %}
                <div class="error-message">{{ form.visuel.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.texture.label(class="form-label") }}
            {{ form.texture(class="form-control") }}
            {% if form.texture.errors %}
                <div class="error-message">{{ form.texture.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.pate.label(class="form-label") }}
            {{ form.pate(class="form-control") }}
            {% if form.pate.errors %}
                <div class="error-message">{{ form.pate.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.gout.label(class="form-label") }}
            {{ form.gout(class="form-control") }}
            {% if form.gout.errors %}
                <div class="error-message">{{ form.gout.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control") }}
            {% if form.description.errors %}
                <div class="error-message">{{ form.description.errors[0] }}</div>
            {% endif %}
        </div>
        {{ form.submit(class="btn btn-proposer") }}
    </form>
{% endmacro %}


<!-- BOUTONS POUR MODIFIER EVALUATION -->
{% macro afficher_boutons_actions(evaluation, current_user) %}
    {% if current_user.id_user == evaluation.id_user %}
        <div class="action-buttons d-flex gap-1">
            <form method="POST" action="{{ url_for('main.modifier_evaluation', id_eval=evaluation.id_eval) }}" style="display: inline-block;">
                <button type="submit" class="btn btn-primary btn-sm square-btn" title="Modifier">
                    <i class="bi bi-pencil"></i>
                </button>
            </form>
            <form method="POST" action="{{ url_for('main.supprimer_evaluation', id_eval=evaluation.id_eval) }}" style="display: inline-block;">
                <button type="submit" class="btn btn-danger btn-sm square-btn" title="Supprimer">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </div>
    {% elif current_user.is_admin %}
        <div class="action-buttons">
            <form method="POST" action="{{ url_for('main.valider_evaluation', id_eval=evaluation.id_eval) }}" style="display: inline-block;">
                <button type="submit" class="btn btn-success square-btn" title="Valider">
                    <i class="bi bi-check"></i>
                </button>
            </form>
            <form method="POST" action="{{ url_for('main.supprimer_evaluation', id_eval=evaluation.id_eval) }}" style="display: inline-block;">
                <button type="submit" class="btn btn-danger square-btn" title="Supprimer">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </div>
    {% endif %}
{% endmacro %}
