<!-- MACROS D'AFFICHAGE -->
{% macro afficher_image_ou_placeholder(item, classe='card-image') %}
    {% if item.photos %}
        <img src="{{ url_for('static', filename='uploads/' + item.photos[0].path) }}" alt="{{ item.nom }}" class="{{ classe }}">
    {% else %}
        <div class="{{ classe }} placeholder"><span>Pas de photo</span></div>
    {% endif %}
{% endmacro %}

<!-- MACROS DE BADGES -->
{% macro afficher_badge(type, objet, current_user=None) %}
    {% if type == 'etablissement' %}
        {% if objet.label %}
            <span class="badge">⭐ Labellisé</span>
        {% endif %}
    {% elif type == 'flan' %}
        {% if objet.prix is not none %}
            <span class="badge">{{ "%.2f"|format(objet.prix) }} €</span>
        {% else %}
            <span class="badge">Prix non renseigné</span>
        {% endif %}
    {% elif type == 'statut' %}
        {% if current_user and current_user.is_authenticated and (current_user.is_admin or objet.user_id == current_user.user_id) %}
            {% if objet.statut.value == 'VALIDE' %}
                <span class="badge statut-valide">Valide</span>
            {% elif objet.statut.value == 'EN_ATTENTE' %}
                <span class="badge statut-en-attente">En attente</span>
            {% endif %}
        {% endif %}
    {% endif %}
{% endmacro %}
<!-- MACROS D'AFFICHAGE D'OBJETS -->
{% macro afficher_objet(type, objet, current_user=None, form=None) %}
    {% if type == 'etablissement' %}
        <div class="etablissement-card">
            {% if current_user.is_authenticated and (current_user.id_user == objet.id_user or current_user.is_admin) %}
                <div id="etablissement-{{ objet.id_etab }}-display">
                    <div class="card-image-container">
                        {{ afficher_image_ou_placeholder(objet) }}
                        {{ afficher_badge('etablissement', objet) }}
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h2>{{ objet.nom | enlever_accents }}</h2>
                        </div>
                        <p class="type">{{ objet.type_etab.value }}</p>
                        <p class="adresse">{{ objet.adresse }}, {{ objet.ville }}</p>
                        {% if objet.flans %}
                            <p class="flans-count">{{ objet.flans|length }} flan{{ 's' if objet.flans|length > 1 else '' }}</p>
                        {% endif %}
                        {{ afficher_boutons_actions(objet, current_user, 'id_etab', 'maps.modifier_etablissement', 'maps.supprimer_etablissement', 'maps.valider_etablissement', 'etablissement') }}
                    </div>
                </div>
                <div id="etablissement-{{ objet.id_etab }}-edit" style="display: none;">
                    <form method="POST" action="{{ url_for('maps.modifier_etablissement', id_etab=objet.id_etab) }}" class="form-container">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            <label for="nom-{{ objet.id_etab }}" class="form-label">Nom</label>
                            <input type="text" id="nom-{{ objet.id_etab }}" name="nom" class="form-control" value="{{ objet.nom }}">
                        </div>
                        <div class="form-group">
                            <label for="description-{{ objet.id_etab }}" class="form-label">Description</label>
                            <textarea id="description-{{ objet.id_etab }}" name="description" class="form-control">{{ objet.description }}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="adresse-{{ objet.id_etab }}" class="form-label">Adresse</label>
                            <input type="text" id="adresse-{{ objet.id_etab }}" name="adresse" class="form-control" value="{{ objet.adresse }}">
                        </div>
                        <div class="form-group">
                            <label for="ville-{{ objet.id_etab }}" class="form-label">Ville</label>
                            <input type="text" id="ville-{{ objet.id_etab }}" name="ville" class="form-control" value="{{ objet.ville }}">
                        </div>
                        <div class="form-group">
                            <label for="code_postal-{{ objet.id_etab }}" class="form-label">Code Postal</label>
                            <input type="text" id="code_postal-{{ objet.id_etab }}" name="code_postal" class="form-control" value="{{ objet.code_postal }}">
                        </div>
                        <div class="form-group">
                            <label for="latitude-{{ objet.id_etab }}" class="form-label">Latitude</label>
                            <input type="text" id="latitude-{{ objet.id_etab }}" name="latitude" class="form-control" value="{{ objet.latitude }}">
                        </div>
                        <div class="form-group">
                            <label for="longitude-{{ objet.id_etab }}" class="form-label">Longitude</label>
                            <input type="text" id="longitude-{{ objet.id_etab }}" name="longitude" class="form-control" value="{{ objet.longitude }}">
                        </div>
                        <div class="form-group">
                            <label for="type_etab-{{ objet.id_etab }}" class="form-label">Type d'établissement</label>
                            <select id="type_etab-{{ objet.id_etab }}" name="type_etab" class="form-control">
                                {% for choice in form.type_etab.choices %}
                                    <option value="{{ choice[0] }}" {% if choice[0] == objet.type_etab.value %}selected{% endif %}>{{ choice[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit({{ objet.id_etab }})">Annuler</button>
                        </div>
                    </form>
                </div>
            {% else %}
                <div class="card-content">
                    <div class="card-header">
                        <h2>{{ objet.nom | enlever_accents }}</h2>
                    </div>
                    <p class="type">{{ objet.type_etab.value }}</p>
                    <p class="adresse">{{ objet.adresse }}, {{ objet.ville }}</p>
                    {% if objet.flans %}
                        <p class="flans-count">{{ objet.flans|length }} flan{{ 's' if objet.flans|length > 1 else '' }}</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        <script>
            function editEtablissement(idEtablissement) {
                document.getElementById('etablissement-' + idEtablissement + '-display').style.display = 'none';
                document.getElementById('etablissement-' + idEtablissement + '-edit').style.display = 'block';
            }
            function cancelEdit(idEtablissement) {
                document.getElementById('etablissement-' + idEtablissement + '-display').style.display = 'block';
                document.getElementById('etablissement-' + idEtablissement + '-edit').style.display = 'none';
            }
        </script>
    {% elif type == 'flan' %}
        <div class="flan-card">
            <div class="card-image-container">
                {{ afficher_image_ou_placeholder(objet) }}
                {{ afficher_badge('flan', objet) }}
            </div>
            {% if current_user.is_authenticated and (current_user.id_user == objet.id_user or current_user.is_admin) %}
                <div id="flan-{{ objet.id_flan }}-display">
                    <div class="card-content">
                        <div class="card-header">
                            <h2>{{ objet.nom | enlever_accents }}</h2>
                        </div>
                        <p class="type">Saveur : {{ objet.type_saveur.value | default("inconnue") }}</p>
                        <p class="type">Pâte : {{ objet.type_pate.value | default("inconnue") }}</p>
                        <p class="type">Texture : {{ objet.type_texture.value | default("inconnue") }}</p>
                        <p class="type">Description : {{ objet.description | default("Flantastique") }}</p>
                        <p class="flan-price">Prix : {{ "%.2f"|format(objet.prix) }} €</p>
                        {{ afficher_boutons_actions(objet, current_user, 'id_flan', 'main.gerer_flan', 'main.supprimer_flan', 'main.valider_flan', 'flan') }}
                    </div>
                </div>
                <div id="flan-{{ objet.id_flan }}-edit" style="display: none;">
                    <form method="POST" action="{{ url_for('main.gerer_flan', id_flan=objet.id_flan) }}" class="form-container">
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            <label for="nom-{{ objet.id_flan }}" class="form-label">Nom</label>
                            <input type="text" id="nom-{{ objet.id_flan }}" name="nom" class="form-control" value="{{ objet.nom }}">
                        </div>
                        <div class="form-group">
                            <label for="description-{{ objet.id_flan }}" class="form-label">Description</label>
                            <textarea id="description-{{ objet.id_flan }}" name="description" class="form-control">{{ objet.description }}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="prix-{{ objet.id_flan }}" class="form-label">Prix</label>
                            <input type="number" id="prix-{{ objet.id_flan }}" name="prix" class="form-control" value="{{ objet.prix }}">
                        </div>
                        <div class="form-group">
                            <label for="type_saveur-{{ objet.id_flan }}" class="form-label">Type de saveur</label>
                            <select id="type_saveur-{{ objet.id_flan }}" name="type_saveur" class="form-control">
                                {% for choice in form.type_saveur.choices %}
                                    <option value="{{ choice[0] }}" {% if choice[0] == objet.type_saveur.value %}selected{% endif %}>{{ choice[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="type_pate-{{ objet.id_flan }}" class="form-label">Type de pâte</label>
                            <select id="type_pate-{{ objet.id_flan }}" name="type_pate" class="form-control">
                                {% for choice in form.type_pate.choices %}
                                    <option value="{{ choice[0] }}" {% if choice[0] == objet.type_pate.value %}selected{% endif %}>{{ choice[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="type_texture-{{ objet.id_flan }}" class="form-label">Type de texture</label>
                            <select id="type_texture-{{ objet.id_flan }}" name="type_texture" class="form-control">
                                {% for choice in form.type_texture.choices %}
                                    <option value="{{ choice[0] }}" {% if choice[0] == objet.type_texture.value %}selected{% endif %}>{{ choice[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit({{ objet.id_flan }})">Annuler</button>
                        </div>
                    </form>
                </div>
            {% else %}
                <div class="card-content">
                    <div class="card-header">
                        <h2>{{ objet.nom | enlever_accents }}</h2>
                    </div>
                    <p class="type">Saveur : {{ objet.type_saveur.value | default("inconnue") }}</p>
                    <p class="type">Pâte : {{ objet.type_pate.value | default("inconnue") }}</p>
                    <p class="type">Texture : {{ objet.type_texture.value | default("inconnue") }}</p>
                    <p class="type">Description : {{ objet.description | default("Flantastique") }}</p>
                    <p class="flan-price">Prix : {{ "%.2f"|format(objet.prix) }} €</p>
                </div>
            {% endif %}
        </div>
        <script>
            function editFlan(idFlan) {
                document.getElementById('flan-' + idFlan + '-display').style.display = 'none';
                document.getElementById('flan-' + idFlan + '-edit').style.display = 'block';
            }
            function cancelEdit(idFlan) {
                document.getElementById('flan-' + idFlan + '-display').style.display = 'block';
                document.getElementById('flan-' + idFlan + '-edit').style.display = 'none';
            }
        </script>
    {% elif type == 'evaluation' %}
        <div class="card">
            <div class="card-content">
                <div class="card-header">
                    {% if objet.flan and objet.flan.etablissement %}
                        <h2>{{ objet.flan.etablissement.nom | enlever_accents }}</h2>
                        <h3>{{ objet.flan.nom | enlever_accents }}</h3>
                    {% else %}
                        <h2>Établissement inconnu</h2>
                        <h3>{{ objet.flan.nom | enlever_accents if objet.flan else 'Flan inconnu' }}</h3>
                    {% endif %}
                    {{ afficher_badge('statut', objet, current_user) }}
                </div>
                <div class="evaluation-date-container">
                    <small class="evaluation-date">
                        {{ objet.date_creation.strftime('%d/%m/%Y') }}
                    </small>
                </div>
                {% if current_user.is_authenticated and (current_user.id_user == objet.id_user or current_user.is_admin) %}
                    <div id="evaluation-{{ objet.id_eval }}-display">
                        {{ afficher_criteres_evaluation(objet) }}
                        {{ afficher_boutons_actions(objet, current_user, 'id_eval', 'main.gerer_evaluation', 'main.supprimer_evaluation', 'main.valider_evaluation', 'evaluation') }}
                    </div>
                    {{ afficher_formulaire_edition_evaluation(objet, form) }}
                {% else %}
                    {{ afficher_criteres_evaluation(objet) }}
                {% endif %}
                <a href="{{ url_for('main.gerer_evaluation', id_eval=objet.id_eval) }}" class="btn btn-primary">Voir plus</a>
            </div>
        </div>
        <script>
            function editEvaluation(idEval) {
                document.getElementById('evaluation-' + idEval + '-display').style.display = 'none';
                document.getElementById('evaluation-' + idEval + '-edit').style.display = 'block';
            }
            function cancelEdit(idEval) {
                document.getElementById('evaluation-' + idEval + '-display').style.display = 'block';
                document.getElementById('evaluation-' + idEval + '-edit').style.display = 'none';
            }
        </script>
    {% endif %}
{% endmacro %}



<!-- MACROS D'AFFICHAGE DE CRITÈRES D'ÉVALUATION -->
{% macro afficher_criteres_evaluation(evaluation) %}
    <div class="criteria">
        <div class="criterion">
            <span class="criterion-name">Visuel :</span>
            <span class="criterion-value">{{ evaluation.visuel }}/5</span>
        </div>
        <div class="criterion">
            <span class="criterion-name">Pâte :</span>
            <span class="criterion-value">{{ evaluation.pate }}/5</span>
        </div>
        <div class="criterion">
            <span class="criterion-name">Texture :</span>
            <span class="criterion-value">{{ evaluation.texture }}/5</span>
        </div>
        <div class="criterion">
            <span class="criterion-name">Goût :</span>
            <span class="criterion-value">{{ evaluation.gout }}/5</span>
        </div>
    </div>
    {% if evaluation.gout is not none and evaluation.texture is not none and evaluation.visuel is not none and evaluation.pate is not none %}
        {% set moyenne = (evaluation.gout + evaluation.texture + evaluation.visuel + evaluation.pate) / 4 %}
        <div class="moyenne">
            <span class="moyenne-value">{{ moyenne }}/5</span>
        </div>
    {% else %}
        <div class="moyenne">
            <span class="moyenne-value">N/A</span>
        </div>
    {% endif %}
    <p class="type">{{ evaluation.description }}</p>
{% endmacro %}

<!-- MACROS DE FORMULAIRES -->
{% macro afficher_formulaire_edition_evaluation(evaluation, form) %}
    <div id="evaluation-{{ evaluation.id_eval }}-edit" style="display: none;">
        <form method="POST" action="{{ url_for('main.gerer_evaluation', id_eval=evaluation.id_eval) }}" class="form-container">
            {{ form.hidden_tag() }}
            <div class="form-group">
                <label for="visuel-{{ evaluation.id_eval }}" class="form-label">Visuel</label>
                <select id="visuel-{{ evaluation.id_eval }}" name="visuel" class="form-control">
                    {% for choice in form.visuel.choices %}
                        <option value="{{ choice[0] }}" {% if choice[0] == evaluation.visuel|float %}selected{% endif %}>{{ choice[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="pate-{{ evaluation.id_eval }}" class="form-label">Pâte</label>
                <select id="pate-{{ evaluation.id_eval }}" name="pate" class="form-control">
                    {% for choice in form.pate.choices %}
                        <option value="{{ choice[0] }}" {% if choice[0] == evaluation.pate|float %}selected{% endif %}>{{ choice[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="texture-{{ evaluation.id_eval }}" class="form-label">Texture</label>
                <select id="texture-{{ evaluation.id_eval }}" name="texture" class="form-control">
                    {% for choice in form.texture.choices %}
                        <option value="{{ choice[0] }}" {% if choice[0] == evaluation.texture|float %}selected{% endif %}>{{ choice[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="gout-{{ evaluation.id_eval }}" class="form-label">Goût</label>
                <select id="gout-{{ evaluation.id_eval }}" name="gout" class="form-control">
                    {% for choice in form.gout.choices %}
                        <option value="{{ choice[0] }}" {% if choice[0] == evaluation.gout|float %}selected{% endif %}>{{ choice[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="description-{{ evaluation.id_eval }}" class="form-label">Description</label>
                <textarea id="description-{{ evaluation.id_eval }}" name="description" class="form-control">{{ evaluation.description }}</textarea>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="cancelEdit({{ evaluation.id_eval }})">Annuler</button>
            </div>
        </form>
    </div>
{% endmacro %}

<!-- MACROS D'AFFICHAGE DE GRILLE -->
{% macro afficher_grille(objet_type, objets, current_user=None, form=None, etablissement=None, flan=None) %}
    {% if not objets %}
        <div class="no-results">
            <p>Aucun {{ objet_type }} trouvé.</p>
        </div>
    {% else %}
        <div class="grille">
            {% for objet in objets %}
                {{ afficher_objet(objet_type, objet, current_user, form) }}
            {% endfor %}
        </div>
    {% endif %}
    <!-- Possibilité d'ajout toujours en fin de grille-->
    {{ afficher_bouton_ajout(objet_type, current_user, etablissement, form, flan) }}
{% endmacro %}

<!-- MACROS POUR PROPOSER DES CHOSES -->
{% macro afficher_champ_formulaire(field) %}
    <div class="form-group">
        {{ field.label(class="form-label") }}
        {{ field(class="form-control") }}
        {% if field.errors %}
            <div class="error-message">{{ field.errors[0] }}</div>
        {% endif %}
    </div>
{% endmacro %}

{% macro afficher_formulaire(type, form, action_url, current_user=None, objet=None) %}
    <form method="POST" action="{{ action_url }}" class="form-container">
        {{ form.hidden_tag() }}
        {% if type == 'flan' %}
            {{ afficher_champ_formulaire(form.nom) }}
            {{ afficher_champ_formulaire(form.type_saveur) }}
            {{ afficher_champ_formulaire(form.type_texture) }}
            {{ afficher_champ_formulaire(form.type_pate) }}
            {{ afficher_champ_formulaire(form.description) }}
            {{ afficher_champ_formulaire(form.prix) }}
        {% elif type == 'etablissement' %}
            {{ afficher_champ_formulaire(form.type_etab) }}
            <div class="form-group">
                <label for="search" class="form-label">Recherche d'établissement</label>
                <input type="text" id="search" class="form-control" placeholder="Rechercher un établissement">
            </div>
            {{ afficher_champ_formulaire(form.description) }}
            {% if current_user.is_admin %}
                <div class="form-group">
                    <label>Labellisé</label><br>
                    <input type="radio" name="label" value="Oui" {% if form.label.data == 'Oui' %}checked{% endif %}> Labellisé par la Flanterie<br>
                    <input type="radio" name="label" value="Non" {% if form.label.data == 'Non' %}checked{% endif %}> Non labellisé
                </div>
                <div class="form-group">
                    <label>Visité</label><br>
                    <input type="radio" name="visite" value="Oui" {% if form.visite.data == 'Oui' %}checked{% endif %}> Visité par la Flanterie<br>
                    <input type="radio" name="visite" value="Non" {% if form.visite.data == 'Non' %}checked{% endif %}> Non visité
                </div>
            {% endif %}
            <input type="hidden" id="nom" name="nom" value="{{ form.nom.data }}">
            <input type="hidden" id="adresse" name="adresse" value="{{ form.adresse.data }}">
            <input type="hidden" id="code_postal" name="code_postal" value="{{ form.code_postal.data }}">
            <input type="hidden" id="ville" name="ville" value="{{ form.ville.data }}">
            <input type="hidden" id="latitude" name="latitude" value="{{ form.latitude.data }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ form.longitude.data }}">
        {% elif type == 'evaluation' %}
            {{ afficher_champ_formulaire(form.visuel) }}
            {{ afficher_champ_formulaire(form.pate) }}
            {{ afficher_champ_formulaire(form.texture) }}
            {{ afficher_champ_formulaire(form.gout) }}
            {{ afficher_champ_formulaire(form.description) }}
        {% endif %}
        <div class="form-group">
            {{ form.submit(class="btn btn-proposer") }}
        </div>
    </form>
{% endmacro %}
<!-- MACROS DE BOUTONS D'ACTIONS -->

{% macro afficher_boutons_actions(objet, current_user, id_field, modify_route, delete_route, validate_route, type_objet) %}
    {% if current_user.is_authenticated %}
        {% if current_user.id_user == objet.id_user and not objet.statut.value == 'VALIDE' %}
            <div class="action-buttons d-flex gap-1">
                {% if type_objet == 'evaluation' %}
                    <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editEvaluation({{ objet[id_field] }})">
                        <i class="bi bi-pencil"></i>
                    </button>
                {% elif type_objet == 'flan' %}
                    <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editFlan({{ objet[id_field] }})">
                        <i class="bi bi-pencil"></i>
                    </button>
                {% elif type_objet == 'etablissement' %}
                    <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editEtablissement({{ objet[id_field] }})">
                        <i class="bi bi-pencil"></i>
                    </button>
                {% endif %}
                <form method="POST" action="{{ url_for(delete_route, **{id_field: objet[id_field]}) }}" style="display: inline-block;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger btn-sm square-btn" title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </div>
        {% elif current_user.is_admin %}
            {% if objet.statut.value == 'EN_ATTENTE' %}
                <div class="action-buttons d-flex gap-1">
                    {% if validate_route %}
                        <form method="POST" action="{{ url_for(validate_route, **{id_field: objet[id_field]}) }}" style="display: inline-block;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-success square-btn" title="Valider">
                                <i class="bi bi-check"></i>
                            </button>
                        </form>
                    {% endif %}
                    {% if type_objet == 'evaluation' %}
                        <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editEvaluation({{ objet[id_field] }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    {% elif type_objet == 'flan' %}
                        <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editFlan({{ objet[id_field] }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    {% elif type_objet == 'etablissement' %}
                        <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editEtablissement({{ objet[id_field] }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    {% endif %}
                    <form method="POST" action="{{ url_for(delete_route, **{id_field: objet[id_field]}) }}" style="display: inline-block;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger square-btn" title="Supprimer">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="action-buttons d-flex gap-1">
                    {% if type_objet == 'evaluation' %}
                        <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editEvaluation({{ objet[id_field] }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    {% elif type_objet == 'flan' %}
                        <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editFlan({{ objet[id_field] }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    {% elif type_objet == 'etablissement' %}
                        <button type="button" class="btn btn-primary btn-sm square-btn" title="Modifier" onclick="editEtablissement({{ objet[id_field] }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    {% endif %}
                    <form method="POST" action="{{ url_for(delete_route, **{id_field: objet[id_field]}) }}" style="display: inline-block;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger square-btn" title="Supprimer">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </div>
            {% endif %}
        {% endif %}
    {% endif %}
{% endmacro %}



<!-- MACROS DE BOUTONS D'AJOUT -->
{% macro afficher_bouton_ajout(objet_type, current_user, etablissement=None, form=None, flan=None) %}
    {% if objet_type == 'etablissement' %}
        <div class="card-content">
            <h3>Ajouter un etablissement</h3>
            {% if current_user.is_authenticated %}
                {{ afficher_formulaire('etablissement', form, url_for('maps.ajouter_etablissement'), current_user) }}
            {% else %}
                <a href="{{ url_for('auth.login', next=request.full_path) }}" class="btn-proposer">
                    Ajouter un établissement (connectez-vous)
                </a>
            {% endif %}
        </div>
    {% elif objet_type == 'flan' and etablissement %}
        <div class="card-content">
            <h3>Ajouter un flan</h3>
            {% if current_user.is_authenticated %}
                {% set action_url = url_for('main.gerer_flan', id_etab=etablissement.id_etab) %}
                {{ afficher_formulaire('flan', form, action_url) }}
            {% else %}
                <a href="{{ url_for('auth.login', next=request.full_path) }}" class="btn-proposer">
                    Ajouter un flan (connectez-vous)
                </a>
            {% endif %}
        </div>
    {% elif objet_type == 'evaluation' and flan %}
        <div class="card-content">
            <h3>Ajouter une evaluation</h3>
            {% if current_user.is_authenticated %}
                {% set action_url = url_for('main.gerer_evaluation', id_flan=flan.id_flan) %}
                {{ afficher_formulaire('evaluation', form, action_url) }}
            {% else %}
                <a href="{{ url_for('auth.login', next=request.full_path) }}" class="btn-proposer">
                    Ajouter une évaluation (connectez-vous)
                </a>
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}
